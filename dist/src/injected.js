(function(){console.log("[FB Ads Scraper] Injected into page context");let d=[],w=!1;function J(){return new Promise(l=>{const u={scrollStep:600,scrollDelay:400,maxIdleCycles:20};let f=0,a=0;const i=(...c)=>console.log("[AutoScroll]",...c),n=()=>{window.scrollTo({top:document.documentElement.scrollHeight,behavior:"smooth"}),i("Final scroll to absolute bottom")},r=async()=>{window.scrollBy(0,u.scrollStep),await new Promise(y=>setTimeout(y,u.scrollDelay));const c=document.documentElement.scrollHeight||document.body.scrollHeight;c>f?(f=c,a=0,i("New content detected"),r()):(a++,i(`No new content (${a}/${u.maxIdleCycles})`),a<u.maxIdleCycles?r():(i("Scrolling complete"),n(),setTimeout(()=>l(),1e3)))};f=document.documentElement.scrollHeight||document.body.scrollHeight,i("Starting infinite auto-scroll"),r()})}function k(){const l={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Sept:8,Oct:9,Nov:10,Dec:11},u=e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),f=(e,t)=>Math.round((u(t)-u(e))/864e5)+1,a=(e,t,o)=>new Date(Number(o),l[e],Number(t)),i=e=>`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]} ${e.getDate()}, ${e.getFullYear()}`,n=/\bLibrary ID:\s*(\d+)\b/,r=/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})\s*[-–—]\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,c=/\bStarted running on\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,y=e=>{var t;return((t=e==null?void 0:e.match(n))==null?void 0:t[1])??null},A=e=>{const t=e.match(r);if(t)return{start:a(t[1],t[2],t[3]),end:a(t[4],t[5],t[6])};const o=e.match(c);return o?{start:a(o[1],o[2],o[3]),end:new Date}:null},m=e=>{let t=e;for(let o=0;o<25&&t;o++){const s=t.innerText||"";if(s.includes("Library ID:")&&(r.test(s)||c.test(s)))return t;t=t.parentElement}return null},p=e=>{try{const t=new URL(e,location.href);t.search="",t.hash="";const o=t.pathname.replace(/\/+$/,"")||"/";return`${t.protocol}//${t.host}${o}`}catch{return null}},D=e=>{try{const t=new URL(e,location.href);if(!t.host.toLowerCase().includes("facebook.com"))return e;const s=t.searchParams.get("u");return s?decodeURIComponent(s):e}catch{return e}},g=e=>{try{const t=new URL(e,location.href),o=t.pathname.replace(/\/+$/,"")||"/";return`${t.host}${o}`}catch{return null}},T=e=>{var C,I;const t=e.closest("div.xh8yej3");if(!t)return{adText:null,links:[]};const o=((I=(C=t.querySelector('[style="white-space: pre-wrap;"]'))==null?void 0:C.innerText)==null?void 0:I.trim())||null,s=Array.from(t.querySelectorAll('a[target="_blank"]')).slice(1),h=new Set,S=[];for(const L of s){const R=L.href;if(!R)continue;const v=D(R);if(v.startsWith("https://www.facebook.com/help/396404120401278/list"))continue;const b=p(v);if(!b)continue;const F=g(b);!F||h.has(F)||(h.add(F),S.push(b))}return{adText:o,links:S}},x=new Set,B=Array.from(document.querySelectorAll("*")).filter(e=>{var t;return(t=e.innerText)==null?void 0:t.includes("Library ID:")});for(const e of B){const t=y(e.innerText);if(!t||x.has(t))continue;const o=m(e);if(!o)continue;const s=A(o.innerText);if(!s)continue;const{adText:h,links:S}=T(e);d.push({libraryId:t,startingDate:i(s.start),endDate:i(s.end),duration:f(s.start,s.end),adText:h,links:S}),x.add(t)}return d.sort((e,t)=>t.duration-e.duration),console.log(`[Ads Analyzer] Found ${d.length} ads`),d}function $(l){if(!Array.isArray(l))return console.warn("Expected results array"),null;const u=n=>new Date(n),f=(n,r)=>Math.round((r-n)/(1e3*60*60*24))+1,a=new Map;for(const n of l){if(!n||!Array.isArray(n.links)||!n.libraryId)continue;const r=u(n.startingDate),c=u(n.endDate),y=Number(n.duration)||0,A=typeof n.adText=="string"?n.adText.trim():"";for(const m of n.links){a.has(m)||a.set(m,{url:m,firstSeen:r,lastSeen:c,totalAdsCount:0,perCopy:new Map});const p=a.get(m);r<p.firstSeen&&(p.firstSeen=r),c>p.lastSeen&&(p.lastSeen=c),p.totalAdsCount++;const D=A||"[no-copy]",g=p.perCopy.get(D);(!g||y>g.duration||y===g.duration&&(new Date(n.startingDate)<new Date(g.startingDate)||n.startingDate===g.startingDate&&new Date(n.endDate)>new Date(g.endDate)))&&p.perCopy.set(D,{libraryId:n.libraryId,startingDate:n.startingDate,endDate:n.endDate,duration:y,adText:A})}}const i=Array.from(a.values()).map(n=>({url:n.url,firstAdvertised:n.firstSeen.toISOString(),lastAdvertised:n.lastSeen.toISOString(),campaignDurationDays:f(n.firstSeen,n.lastSeen),adsCount:n.totalAdsCount,top5:Array.from(n.perCopy.values()).sort((r,c)=>c.duration-r.duration).slice(0,5)})).sort((n,r)=>new Date(n.firstAdvertised)-new Date(r.firstAdvertised));return console.log(`[Campaign Processor] Generated ${i.length} campaigns`),i}async function M(){if(w){console.log("[FB Ads Scraper] Already running, skipping");return}w=!0,d=[];try{console.log("[FB Ads Scraper] Step 1: Auto-scrolling..."),await J(),console.log("[FB Ads Scraper] Step 2: Analyzing ads..."),d=k(),console.log("[FB Ads Scraper] Step 3: Processing campaigns...");const l=$(d);console.log("[FB Ads Scraper] Complete! Sending data..."),window.postMessage({type:"FB_ADS_DATA",data:l,allAds:d},"*")}catch(l){console.error("[FB Ads Scraper] Error:",l),window.postMessage({type:"FB_ADS_ERROR",error:l.message},"*")}finally{w=!1}}window.fbAdsAnalyzer={runFullAnalysis:M,results:d},M()})();
