(function(){console.log("[FB Ads Scraper] Injected into page context");let p=[],T=!1;function B(){return new Promise(i=>{const u={scrollStep:600,scrollDelay:400,maxIdleCycles:20};let y=0,a=0;const d=(...c)=>console.log("[AutoScroll]",...c),n=()=>{window.scrollTo({top:document.documentElement.scrollHeight,behavior:"smooth"}),d("Final scroll to absolute bottom")},r=async()=>{window.scrollBy(0,u.scrollStep),await new Promise(m=>setTimeout(m,u.scrollDelay));const c=document.documentElement.scrollHeight||document.body.scrollHeight;c>y?(y=c,a=0,d("New content detected"),r()):(a++,d(`No new content (${a}/${u.maxIdleCycles})`),a<u.maxIdleCycles?r():(d("Scrolling complete"),n(),setTimeout(()=>i(),1e3)))};y=document.documentElement.scrollHeight||document.body.scrollHeight,d("Starting infinite auto-scroll"),r()})}function N(){const i={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Sept:8,Oct:9,Nov:10,Dec:11},u=t=>new Date(t.getFullYear(),t.getMonth(),t.getDate()),y=(t,e)=>Math.round((u(e)-u(t))/864e5)+1,a=(t,e,o)=>new Date(Number(o),i[t],Number(e)),d=t=>`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}, ${t.getFullYear()}`,n=/\bLibrary ID:\s*(\d+)\b/,r=/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})\s*[-–—]\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,c=/\bStarted running on\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,m=t=>{var e;return((e=t==null?void 0:t.match(n))==null?void 0:e[1])??null},w=t=>{const e=t.match(r);if(e)return{start:a(e[1],e[2],e[3]),end:a(e[4],e[5],e[6])};const o=t.match(c);return o?{start:a(o[1],o[2],o[3]),end:new Date}:null},h=t=>{let e=t;for(let o=0;o<25&&e;o++){const s=e.innerText||"";if(s.includes("Library ID:")&&(r.test(s)||c.test(s)))return e;e=e.parentElement}return null},f=t=>{try{const e=new URL(t,location.href);e.search="",e.hash="";const o=e.pathname.replace(/\/+$/,"")||"/";return`${e.protocol}//${e.host}${o}`}catch{return null}},F=t=>{try{const e=new URL(t,location.href);if(!e.host.toLowerCase().includes("facebook.com"))return t;const s=e.searchParams.get("u");return s?decodeURIComponent(s):t}catch{return t}},x=t=>{try{const e=new URL(t,location.href),o=e.pathname.replace(/\/+$/,"")||"/";return`${e.host}${o}`}catch{return null}},g=t=>{var $,L;const e=t.closest("div.xh8yej3");if(!e)return{adText:null,links:[]};const o=((L=($=e.querySelector('[style="white-space: pre-wrap;"]'))==null?void 0:$.innerText)==null?void 0:L.trim())||null,s=Array.from(e.querySelectorAll('a[target="_blank"]')).slice(1),S=new Set,b=[];let I=null,M=null;const C=e.querySelector("video");if(C&&C.src)I="video",M=C.src;else{const D=Array.from(e.querySelectorAll("img"));D.length>1?(I="image",M=D[1].src):D.length===1&&t.innerText.includes("Library ID:")}for(const D of s){const O=D.href;if(!O)continue;const v=F(O);if(v.startsWith("https://www.facebook.com/help/396404120401278/list")||v.includes("transparency.meta.com/policies"))continue;const R=f(v);if(!R)continue;const k=x(R);!k||S.has(k)||(S.add(k),b.push({url:R,mediaType:I,mediaSrc:M}))}return{adText:o,links:b}},A=new Set,l=Array.from(document.querySelectorAll("*")).filter(t=>{var e;return(e=t.innerText)==null?void 0:e.includes("Library ID:")});for(const t of l){const e=m(t.innerText);if(!e||A.has(e))continue;const o=h(t);if(!o)continue;const s=w(o.innerText);if(!s)continue;const{adText:S,links:b}=g(t);p.push({libraryId:e,startingDate:d(s.start),endDate:d(s.end),duration:y(s.start,s.end),adText:S,links:b}),A.add(e)}return p.sort((t,e)=>e.duration-t.duration),console.log(`[Ads Analyzer] Found ${p.length} ads`),p}function E(i){if(!Array.isArray(i))return console.warn("Expected results array"),null;const u=n=>new Date(n),y=(n,r)=>Math.round((r-n)/(1e3*60*60*24))+1,a=new Map;for(const n of i){if(!n||!Array.isArray(n.links)||!n.libraryId)continue;const r=u(n.startingDate),c=u(n.endDate),m=Number(n.duration)||0,w=typeof n.adText=="string"?n.adText.trim():"";for(const h of n.links){const f=h.url,F=h.mediaType,x=h.mediaSrc;a.has(f)||a.set(f,{url:f,firstSeen:r,lastSeen:c,totalAdsCount:0,perCopy:new Map});const g=a.get(f);r<g.firstSeen&&(g.firstSeen=r),c>g.lastSeen&&(g.lastSeen=c),g.totalAdsCount++;const A=w||"[no-copy]",l=g.perCopy.get(A);(!l||m>l.duration||m===l.duration&&(new Date(n.startingDate)<new Date(l.startingDate)||n.startingDate===l.startingDate&&new Date(n.endDate)>new Date(l.endDate)))&&g.perCopy.set(A,{libraryId:n.libraryId,startingDate:n.startingDate,endDate:n.endDate,duration:m,adText:w,mediaType:F||(l?l.mediaType:null),mediaSrc:x||(l?l.mediaSrc:null)})}}const d=Array.from(a.values()).map(n=>({url:n.url,firstAdvertised:n.firstSeen.toISOString(),lastAdvertised:n.lastSeen.toISOString(),campaignDurationDays:y(n.firstSeen,n.lastSeen),adsCount:n.totalAdsCount,top5:Array.from(n.perCopy.values()).sort((r,c)=>c.duration-r.duration).slice(0,5)})).sort((n,r)=>new Date(n.firstAdvertised)-new Date(r.firstAdvertised));return console.log(`[Campaign Processor] Generated ${d.length} campaigns`),d}async function J(){if(T){console.log("[FB Ads Scraper] Already running, skipping");return}T=!0,p=[];try{console.log("[FB Ads Scraper] Step 1: Auto-scrolling..."),await B(),console.log("[FB Ads Scraper] Step 2: Analyzing ads..."),p=N(),console.log("[FB Ads Scraper] Step 3: Processing campaigns...");const i=E(p);console.log("[FB Ads Scraper] Complete! Sending data..."),window.postMessage({type:"FB_ADS_DATA",data:i,allAds:p},"*")}catch(i){console.error("[FB Ads Scraper] Error:",i),window.postMessage({type:"FB_ADS_ERROR",error:i.message},"*")}finally{T=!1}}window.fbAdsAnalyzer={runFullAnalysis:J,results:p},J()})();
