(function(){console.log("[FB Ads Scraper] Injected into page context");let p=[],b=!1;document.body.setAttribute("data-fb-ads-scraper-loaded","true");function O(){return new Promise(y=>{console.log("[FB Ads Scraper] Starting auto-scroll...");let u=document.body.scrollHeight,f=0;const c=Date.now(),i=(a,s=!1)=>{const l=Math.round((Date.now()-c)/1e3);document.dispatchEvent(new CustomEvent("fbAdsStatus",{detail:{scrolling:!s,adsFound:a,elapsed:l,message:s?`Analysis Complete (${l}s)`:`Analyzing... (${l}s)`}}))},n=setInterval(()=>{window.scrollTo(0,document.body.scrollHeight);const a=document.querySelectorAll('a[href*="/ads/library/?id="]');let s=0;const l=new Set;a.forEach(A=>{const g=A.href.match(/id=(\d+)/);g&&!l.has(g[1])&&(l.add(g[1]),s++)}),i(s);const h=document.body.scrollHeight;h===u?f++:(f=0,u=h),f>=6&&(clearInterval(n),i(s,!0),console.log("[FB Ads Scraper] Auto-scroll finished. Ads found:",s),y())},500)})}function B(){const y={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Sept:8,Oct:9,Nov:10,Dec:11},u=t=>new Date(t.getFullYear(),t.getMonth(),t.getDate()),f=(t,e)=>Math.round((u(e)-u(t))/864e5)+1,c=(t,e,r)=>new Date(Number(r),y[t],Number(e)),i=t=>`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}, ${t.getFullYear()}`,n=/\bLibrary ID:\s*(\d+)\b/,a=/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\.?\s+(\d{1,2})\s*,\s*(\d{4})\s*[-–—]\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\.?\s+(\d{1,2})\s*,\s*(\d{4})/i,s=/\bStarted running on\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\.?\s+(\d{1,2})\s*,\s*(\d{4})/i,l=t=>{var e;return((e=t==null?void 0:t.match(n))==null?void 0:e[1])??null},h=t=>{const e=t.match(a);if(e)return{start:c(e[1],e[2],e[3]),end:c(e[4],e[5],e[6])};const r=t.match(s);return r?{start:c(r[1],r[2],r[3]),end:new Date}:null},A=t=>{let e=t;for(let r=0;r<25&&e;r++){const o=e.innerText||"";if(o.includes("Library ID:")&&(a.test(o)||s.test(o)))return e;e=e.parentElement}return null},g=t=>{try{const e=new URL(t,location.href);e.search="",e.hash="";const r=e.pathname.replace(/\/+$/,"")||"/";return`${e.protocol}//${e.host}${r}`}catch{return null}},F=t=>{try{const e=new URL(t,location.href);if(!e.host.toLowerCase().includes("facebook.com"))return t;const o=e.searchParams.get("u");return o?decodeURIComponent(o):t}catch{return t}},C=t=>{try{const e=new URL(t,location.href),r=e.pathname.replace(/\/+$/,"")||"/";return`${e.host}${r}`}catch{return null}},m=t=>{var $,E;const e=t.closest("div.xh8yej3");if(!e)return{adText:null,links:[]};const r=((E=($=e.querySelector('[style="white-space: pre-wrap;"]'))==null?void 0:$.innerText)==null?void 0:E.trim())||null,o=Array.from(e.querySelectorAll('a[target="_blank"]')).slice(1),D=new Set,v=[];let I=null,M=null;const x=e.querySelector("video");if(x&&x.src)I="video",M=x.src;else{const w=Array.from(e.querySelectorAll("img"));w.length>1?(I="image",M=w[1].src):w.length===1&&t.innerText.includes("Library ID:")}for(const w of o){const L=w.href;if(!L)continue;const k=F(L);if(k.startsWith("https://www.facebook.com/help/396404120401278/list")||k.includes("transparency.meta.com/policies"))continue;const R=g(k);if(!R)continue;const J=C(R);!J||D.has(J)||(D.add(J),v.push({url:R,mediaType:I,mediaSrc:M}))}return{adText:r,links:v}},S=new Set,d=Array.from(document.querySelectorAll("*")).filter(t=>{var e;return(e=t.innerText)==null?void 0:e.includes("Library ID:")});for(const t of d){const e=l(t.innerText);if(!e||S.has(e))continue;const r=A(t);if(!r)continue;const o=h(r.innerText);if(!o)continue;const{adText:D,links:v}=m(t);p.push({libraryId:e,startingDate:i(o.start),endDate:i(o.end),duration:f(o.start,o.end),adText:D,links:v}),S.add(e)}return p.sort((t,e)=>e.duration-t.duration),console.log(`[Ads Analyzer] Found ${p.length} ads`),p}function q(y){if(!Array.isArray(y))return console.warn("Expected results array"),null;const u=n=>new Date(n),f=(n,a)=>Math.round((a-n)/(1e3*60*60*24))+1,c=new Map;for(const n of y){if(!n||!Array.isArray(n.links)||!n.libraryId)continue;const a=u(n.startingDate),s=u(n.endDate),l=Number(n.duration)||0,h=typeof n.adText=="string"?n.adText.trim():"";for(const A of n.links){const g=A.url,F=A.mediaType,C=A.mediaSrc;c.has(g)||c.set(g,{url:g,firstSeen:a,lastSeen:s,totalAdsCount:0,perCopy:new Map});const m=c.get(g);a<m.firstSeen&&(m.firstSeen=a),s>m.lastSeen&&(m.lastSeen=s),m.totalAdsCount++;const S=h||"[no-copy]",d=m.perCopy.get(S);(!d||l>d.duration||l===d.duration&&(new Date(n.startingDate)<new Date(d.startingDate)||n.startingDate===d.startingDate&&new Date(n.endDate)>new Date(d.endDate)))&&m.perCopy.set(S,{libraryId:n.libraryId,startingDate:n.startingDate,endDate:n.endDate,duration:l,adText:h,mediaType:F||(d?d.mediaType:null),mediaSrc:C||(d?d.mediaSrc:null)})}}const i=Array.from(c.values()).map(n=>({url:n.url,firstAdvertised:n.firstSeen.toISOString(),lastAdvertised:n.lastSeen.toISOString(),campaignDurationDays:f(n.firstSeen,n.lastSeen),adsCount:n.totalAdsCount,top5:Array.from(n.perCopy.values()).sort((a,s)=>s.duration-a.duration).slice(0,5)})).sort((n,a)=>new Date(n.firstAdvertised)-new Date(a.firstAdvertised));return console.log(`[Campaign Processor] Generated ${i.length} campaigns`),i}async function T(){var y,u,f,c;if(b){console.log("[FB Ads Scraper] Already running, skipping");return}b=!0,p=[];try{console.log("[FB Ads Scraper] Step 1: Auto-scrolling..."),await O(),console.log("[FB Ads Scraper] Step 2: Analyzing ads..."),p=B(),console.log("[FB Ads Scraper] Step 3: Processing campaigns...");const i=q(p),n=((u=(y=document.querySelector('input[placeholder*="Search by"]'))==null?void 0:y.value)==null?void 0:u.trim())||((c=(f=document.querySelector("h1"))==null?void 0:f.innerText)==null?void 0:c.trim())||"unknown-advertiser";console.log("[FB Ads Scraper] Complete! Sending data..."),document.dispatchEvent(new CustomEvent("fbAdsImportData",{detail:{campaigns:i,allAds:p,metadata:{advertiserName:n,scrapedAt:new Date().toISOString()}}}))}catch(i){console.error("[FB Ads Scraper] Error:",i),window.postMessage({type:"FB_ADS_ERROR",error:i.message},"*")}finally{b=!1}}window.fbAdsAnalyzer={runFullAnalysis:T,results:p,restart:()=>{console.log("[FB Ads Scraper] Soft restarting..."),window.scrollTo(0,0),b=!1,p=[],setTimeout(T,500)}},document.addEventListener("fbAdsRestart",()=>{window.fbAdsAnalyzer.restart()}),T()})();
