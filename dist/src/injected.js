(function(){console.log("[FB Ads Scraper] Injected into page context");let d=[],w=!1;function J(){return new Promise(l=>{const u={scrollStep:600,scrollDelay:400,maxIdleCycles:20};let y=0,a=0;const i=(...c)=>console.log("[AutoScroll]",...c),n=()=>{window.scrollTo({top:document.documentElement.scrollHeight,behavior:"smooth"}),i("Final scroll to absolute bottom")},r=async()=>{window.scrollBy(0,u.scrollStep),await new Promise(f=>setTimeout(f,u.scrollDelay));const c=document.documentElement.scrollHeight||document.body.scrollHeight;c>y?(y=c,a=0,i("New content detected"),r()):(a++,i(`No new content (${a}/${u.maxIdleCycles})`),a<u.maxIdleCycles?r():(i("Scrolling complete"),n(),setTimeout(()=>l(),1e3)))};y=document.documentElement.scrollHeight||document.body.scrollHeight,i("Starting infinite auto-scroll"),r()})}function k(){const l={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Sept:8,Oct:9,Nov:10,Dec:11},u=t=>new Date(t.getFullYear(),t.getMonth(),t.getDate()),y=(t,e)=>Math.round((u(e)-u(t))/864e5)+1,a=(t,e,o)=>new Date(Number(o),l[t],Number(e)),i=t=>`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}, ${t.getFullYear()}`,n=/\bLibrary ID:\s*(\d+)\b/,r=/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})\s*[-–—]\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,c=/\bStarted running on\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{1,2}),\s+(\d{4})/i,f=t=>{var e;return((e=t==null?void 0:t.match(n))==null?void 0:e[1])??null},A=t=>{const e=t.match(r);if(e)return{start:a(e[1],e[2],e[3]),end:a(e[4],e[5],e[6])};const o=t.match(c);return o?{start:a(o[1],o[2],o[3]),end:new Date}:null},m=t=>{let e=t;for(let o=0;o<25&&e;o++){const s=e.innerText||"";if(s.includes("Library ID:")&&(r.test(s)||c.test(s)))return e;e=e.parentElement}return null},p=t=>{try{const e=new URL(t,location.href);e.search="",e.hash="";const o=e.pathname.replace(/\/+$/,"")||"/";return`${e.protocol}//${e.host}${o}`}catch{return null}},D=t=>{try{const e=new URL(t,location.href);if(!e.host.toLowerCase().includes("facebook.com"))return t;const s=e.searchParams.get("u");return s?decodeURIComponent(s):t}catch{return t}},g=t=>{try{const e=new URL(t,location.href),o=e.pathname.replace(/\/+$/,"")||"/";return`${e.host}${o}`}catch{return null}},x=t=>{var I,R;const e=t.closest("div.xh8yej3");if(!e)return{adText:null,links:[]};const o=((R=(I=e.querySelector('[style="white-space: pre-wrap;"]'))==null?void 0:I.innerText)==null?void 0:R.trim())||null,s=Array.from(e.querySelectorAll('a[target="_blank"]')).slice(1),h=new Set,S=[];for(const L of s){const v=L.href;if(!v)continue;const b=D(v);if(b.startsWith("https://www.facebook.com/help/396404120401278/list")||b.includes("transparency.meta.com/policies"))continue;const F=p(b);if(!F)continue;const M=g(F);!M||h.has(M)||(h.add(M),S.push(F))}return{adText:o,links:S}},C=new Set,B=Array.from(document.querySelectorAll("*")).filter(t=>{var e;return(e=t.innerText)==null?void 0:e.includes("Library ID:")});for(const t of B){const e=f(t.innerText);if(!e||C.has(e))continue;const o=m(t);if(!o)continue;const s=A(o.innerText);if(!s)continue;const{adText:h,links:S}=x(t);d.push({libraryId:e,startingDate:i(s.start),endDate:i(s.end),duration:y(s.start,s.end),adText:h,links:S}),C.add(e)}return d.sort((t,e)=>e.duration-t.duration),console.log(`[Ads Analyzer] Found ${d.length} ads`),d}function $(l){if(!Array.isArray(l))return console.warn("Expected results array"),null;const u=n=>new Date(n),y=(n,r)=>Math.round((r-n)/(1e3*60*60*24))+1,a=new Map;for(const n of l){if(!n||!Array.isArray(n.links)||!n.libraryId)continue;const r=u(n.startingDate),c=u(n.endDate),f=Number(n.duration)||0,A=typeof n.adText=="string"?n.adText.trim():"";for(const m of n.links){a.has(m)||a.set(m,{url:m,firstSeen:r,lastSeen:c,totalAdsCount:0,perCopy:new Map});const p=a.get(m);r<p.firstSeen&&(p.firstSeen=r),c>p.lastSeen&&(p.lastSeen=c),p.totalAdsCount++;const D=A||"[no-copy]",g=p.perCopy.get(D);(!g||f>g.duration||f===g.duration&&(new Date(n.startingDate)<new Date(g.startingDate)||n.startingDate===g.startingDate&&new Date(n.endDate)>new Date(g.endDate)))&&p.perCopy.set(D,{libraryId:n.libraryId,startingDate:n.startingDate,endDate:n.endDate,duration:f,adText:A})}}const i=Array.from(a.values()).map(n=>({url:n.url,firstAdvertised:n.firstSeen.toISOString(),lastAdvertised:n.lastSeen.toISOString(),campaignDurationDays:y(n.firstSeen,n.lastSeen),adsCount:n.totalAdsCount,top5:Array.from(n.perCopy.values()).sort((r,c)=>c.duration-r.duration).slice(0,5)})).sort((n,r)=>new Date(n.firstAdvertised)-new Date(r.firstAdvertised));return console.log(`[Campaign Processor] Generated ${i.length} campaigns`),i}async function T(){if(w){console.log("[FB Ads Scraper] Already running, skipping");return}w=!0,d=[];try{console.log("[FB Ads Scraper] Step 1: Auto-scrolling..."),await J(),console.log("[FB Ads Scraper] Step 2: Analyzing ads..."),d=k(),console.log("[FB Ads Scraper] Step 3: Processing campaigns...");const l=$(d);console.log("[FB Ads Scraper] Complete! Sending data..."),window.postMessage({type:"FB_ADS_DATA",data:l,allAds:d},"*")}catch(l){console.error("[FB Ads Scraper] Error:",l),window.postMessage({type:"FB_ADS_ERROR",error:l.message},"*")}finally{w=!1}}window.fbAdsAnalyzer={runFullAnalysis:T,results:d},T()})();
