console.log("[FB Ads Analyzer] Background script loaded");chrome.runtime.onMessage.addListener((o,s,e)=>{if(o.action==="analyzeAI")return l(o,e),!0});const i="https://us-central1-fb-ads-analyzer.cloudfunctions.net/analyzeAds";async function l(o,s){try{console.log("[Background] Starting AI Analysis via Cloud Function...");const{systemPrompt:e,userContent:a}=o.payload,t=(await chrome.storage.local.get("fbAdsIdToken")).fbAdsIdToken;if(!t)throw new Error("User not authenticated. Please open the extension popup to refresh login.");const r=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({systemPrompt:e,userContent:a})});if(!r.ok){const c=await r.text();throw new Error(`Server Error: ${r.status} - ${c}`)}const n=await r.json();if(n.error)throw new Error(n.error);console.log("[Background] AI Analysis successful"),s({success:!0,analysis:n.analysis})}catch(e){console.error("[Background] AI Analysis failed:",e),s({success:!1,error:e.message})}}
