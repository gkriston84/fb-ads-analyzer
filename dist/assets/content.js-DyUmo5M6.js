(function(){console.log("[FB Ads Analyzer] Content script loaded");chrome.runtime.onMessage.addListener((t,s,d)=>{if(t.action==="startScraping")console.log("[FB Ads Analyzer] Starting scraping process"),a(t.aiConfig),d({status:"started"});else if(t.action==="loadData"||t.action==="importData")console.log("[FB Ads Analyzer] Loading imported data"),r(t.data,t.aiConfig),d({status:"loaded"});else if(t.action==="checkExisting"){console.log("[FB Ads Analyzer] Checking for existing overlay");const e=!!document.getElementById("fbAdsAnalyzerOverlay");d({hasOverlay:e})}else if(t.action==="reopenOverlay"){console.log("[FB Ads Analyzer] Reopening overlay");const e=new CustomEvent("fbAdsReopen");document.dispatchEvent(e),d({status:"reopened"})}return!0});document.addEventListener("fbAdsAnalyzeRequest",t=>{const{apiKey:s,systemPrompt:d,userContent:e}=t.detail;console.log("[FB Ads Analyzer] Proxying AI request to background"),chrome.runtime.sendMessage({action:"analyzeAI",payload:{apiKey:s,systemPrompt:d,userContent:e}},o=>{const i=new CustomEvent("fbAdsAnalyzeResponse",{detail:o});document.dispatchEvent(i)})});function a(t){const s=document.getElementById("fbAdsAnalyzerOverlay"),d=document.body.getAttribute("data-fb-ads-scraper-loaded")==="true";if(s){if(d)console.log("[FB Ads Analyzer] Already running, restarting analysis..."),document.dispatchEvent(new CustomEvent("fbAdsRestart"));else{console.log("[FB Ads Analyzer] Visualizer exists but scraper missing. Injecting scraper...");const c=document.createElement("script");c.src=chrome.runtime.getURL("src/injected.js"),c.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(c)}t&&setTimeout(()=>{const c=new CustomEvent("fbAdsConfig",{detail:t});document.dispatchEvent(c)},500);return}let e=document.getElementById("fbAdsConfig");e||(e=document.createElement("div"),e.id="fbAdsConfig",e.style.display="none",document.body.appendChild(e)),e.dataset.logoUrl=chrome.runtime.getURL("logo.jpg");const o=document.createElement("script");o.src=chrome.runtime.getURL("src/injected.js"),o.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(o);const i=document.createElement("script");i.src=chrome.runtime.getURL("src/visualizer.js"),i.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(i);const n=document.createElement("link");n.rel="stylesheet",n.href=chrome.runtime.getURL("src/visualizer.css"),(document.head||document.documentElement).appendChild(n),t&&setTimeout(()=>{const c=new CustomEvent("fbAdsConfig",{detail:t});document.dispatchEvent(c)},500)}function r(t,s){if(document.getElementById("fbAdsAnalyzerOverlay")){console.log("[FB Ads Analyzer] Visualizer exists, sending data via CustomEvent");const n=new CustomEvent("fbAdsImportData",{detail:{...t,isImported:!0}});document.dispatchEvent(n),s&&setTimeout(()=>{const c=new CustomEvent("fbAdsConfig",{detail:s});document.dispatchEvent(c)},200);return}let e=document.getElementById("fbAdsConfig");e||(e=document.createElement("div"),e.id="fbAdsConfig",e.style.display="none",document.body.appendChild(e)),e.dataset.logoUrl=chrome.runtime.getURL("logo.jpg");const o=document.createElement("div");o.id="fbAdsImportedData",o.style.display="none",o.textContent=JSON.stringify({...t,isImported:!0}),document.body.appendChild(o);const i=document.createElement("script");if(i.src=chrome.runtime.getURL("src/visualizer.js"),i.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(i),!document.querySelector('link[href*="visualizer.css"]')){const n=document.createElement("link");n.rel="stylesheet",n.href=chrome.runtime.getURL("src/visualizer.css"),(document.head||document.documentElement).appendChild(n)}s&&setTimeout(()=>{const n=new CustomEvent("fbAdsConfig",{detail:s});document.dispatchEvent(n)},500)}
})()
